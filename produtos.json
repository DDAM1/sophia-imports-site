import requests
from bs4 import BeautifulSoup
import json
import math

BASE_URL = "https://www.megaeletronicos.com"
CONVERSION_RATE = 0.0037  # Aproximado guarani -> real
LUCRO = 1.6  # 60% de lucro

def get_all_categories():
    url = BASE_URL
    resp = requests.get(url)
    soup = BeautifulSoup(resp.text, 'html.parser')
    categorias = []
    
    # Novamente, no site atual, categorias ficam dentro de div com id 'menu-mobile' e class 'menu-list'
    menu = soup.find('div', id='menu-mobile')
    if not menu:
        print("Não achou o menu-mobile")
        return categorias
    links = menu.find_all('a', href=True)
    for link in links:
        href = link['href']
        nome = link.get_text(strip=True)
        if href.startswith('/categoria/'):
            categorias.append({
                "nome": nome,
                "url": BASE_URL + href
            })
    return categorias

def get_products_from_category(cat_url):
    produtos = []
    pagina = 1
    while True:
        url = f"{cat_url}?page={pagina}"
        resp = requests.get(url)
        if resp.status_code != 200:
            break
        soup = BeautifulSoup(resp.text, 'html.parser')
        # Na página da categoria, os produtos estão em divs com class 'produtos'
        lista_produtos = soup.select('div.produtos div.produto')
        if not lista_produtos:
            break
        for item in lista_produtos:
            nome_tag = item.find('h3')
            preco_tag = item.find('span', class_='price')
            img_tag = item.find('img')
            link_tag = item.find('a', href=True)
            if not (nome_tag and preco_tag and img_tag and link_tag):
                continue
            nome_text = nome_tag.get_text(strip=True)
            preco_text = preco_tag.get_text(strip=True).replace('Gs.', '').replace('.', '').replace(',', '.').strip()
            try:
                preco_guarani = float(preco_text)
            except:
                preco_guarani = 0
            preco_real = preco_guarani * CONVERSION_RATE * LUCRO
            preco_real = math.ceil(preco_real * 100) / 100
            preco_formatado = f"R$ {preco_real:.2f}"
            img_url = img_tag.get('src')
            if img_url and img_url.startswith('/'):
                img_url = BASE_URL + img_url
            link_url = link_tag['href']
            if link_url and link_url.startswith('/'):
                link_url = BASE_URL + link_url

            produtos.append({
                "nome": nome_text,
                "preco": preco_formatado,
                "imagem": img_url,
                "link": link_url
            })
        pagina += 1
    return produtos

def main():
    categorias = get_all_categories()
    print(f"Categorias encontradas: {[c['nome'] for c in categorias]}")
    todos_produtos = []
    for cat in categorias:
        print(f"Buscando produtos da categoria: {cat['nome']}")
        produtos_cat = get_products_from_category(cat['url'])
        print(f"Encontrados {len(produtos_cat)} produtos na categoria {cat['nome']}")
        todos_produtos.extend(produtos_cat)
    with open('produtos.json', 'w', encoding='utf-8') as f:
        json.dump(todos_produtos, f, ensure_ascii=False, indent=2)
    print(f"Total de produtos salvos: {len(todos_produtos)}")

if __name__ == "__main__":
    main()
